5. Component Architecture
This section defines the new logical components required for the enhancement and illustrates how they will integrate with the existing application architecture.

New Components
DatabaseProvider
Responsibility: This component's sole responsibility is to initialize the WatermelonDB instance and provide it to the entire application using a React Context. It will wrap the root of the application layout.

Integration Points: It will be placed at the top level of the component tree, likely in app/_layout.tsx, making the database connection available to all child components and hooks.

Technology Stack: React, TypeScript.

SyncService
Responsibility: This is a non-UI, singleton service that encapsulates all logic for data synchronization. It will manage the queue of local changes and orchestrate the push/pull of data with the Supabase backend. It will be the only part of the application that communicates directly with Supabase.

Integration Points: It will be triggered by network status changes and application state events (like startup). It reads from the local WatermelonDB to find pending changes and writes back to it after a successful sync.

Technology Stack: TypeScript, Neverthrow, Supabase JS Client.

useNetworkStatus Hook
Responsibility: A custom React hook that utilizes @react-native-community/netinfo to provide a simple, reactive boolean flag (isOnline) to any component that needs it.

Integration Points: This hook will be used by the SyncService to trigger synchronization and by UI components to display offline/online status indicators.

Technology Stack: React, TypeScript, @react-native-community/netinfo.

Refactored Data Hooks (e.g., useTasksQueries, useTasksMutations)
Responsibility: These existing hooks will be fundamentally refactored. Their new responsibility is to act as a clean interface between the UI components and the local WatermelonDB, not the network.

Integration Points: They will replace direct Supabase calls with WatermelonDB queries. For read operations, they will use observable queries to make the UI reactive. For write operations, they will write directly to the local database, providing an instant, optimistic UI update.

Technology Stack: React, TypeScript, TanStack Query (for sync state), WatermelonDB.

Component Interaction Diagram
This diagram illustrates the new data flow, showing how the UI is now decoupled from direct network operations.

Kod snippet'i

graph TD
    subgraph "React Native Application"
        UI_Components["UI Components (Screens, Buttons)"]
        Refactored_Hooks["Refactored Data Hooks"]
        WDB["WatermelonDB (Local DB)"]
        SyncService["SyncService"]
        useNetworkStatus["useNetworkStatus Hook"]
    end

    subgraph "External Services"
        Supabase["Supabase Backend"]
        NetInfo["Device Network Status"]
    end

    UI_Components -- "Call Hooks (e.g., createTask)" --> Refactored_Hooks
    Refactored_Hooks -- "Write/Read Local Data" --> WDB
    WDB -- "Observable Queries Update UI" --> UI_Components

    SyncService -- "Reads Pending Changes" --> WDB
    SyncService -- "Pushes/Pulls Data" --> Supabase
    Supabase -- "Returns Data/Status" --> SyncService
    SyncService -- "Updates Local DB" --> WDB

    useNetworkStatus -- "Detects Status" --> NetInfo
    useNetworkStatus -- "Triggers Sync" --> SyncService
