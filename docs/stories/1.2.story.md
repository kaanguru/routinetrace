# Story 1.2: Implement Data Persistence and Sync Layer

## Status: Aproved without tests

## Story

-   **As a** developer,
-   **I want** to set up the core Legend-State persistence and synchronization layer,
-   **so that** the application state can be stored locally for offline access and synced with Supabase when online.

## Acceptance Criteria (ACs)

1.  Legend-State is configured with the `AsyncStorage` plugin for local persistence.
2.  Legend-State is configured with the `@legendapp/state/sync-plugins/supabase` plugin.
3.  A high-level `DataSyncProvider` component is created that wraps the entire application.
4.  The application initializes the persistence layer on startup.
5. Core data observables (e.g., `tasks$`, `healthAndHappiness$`, `checklistitems$`) are defined and configured for Supabase sync.

## Tasks / Subtasks

-   [x] **Task 1: Install Dependencies** (AC: 1, 2)
    -   [x] Add `@legendapp/state@beta` and `@react-native-async-storage/async-storage` to the project's dependencies.
-   [x] **Task 2: Configure Persistence** (AC: 1, 4)
    -   [x] Create a configuration file (e.g., `~/data/legendStateConfig.ts`) to initialize and configure Legend-State persistence using `AsyncStorage`.
-   [ ] **Task 3: Define Global Observables** (AC: 5)
    - [x] In a new file (e.g., `~/data/observables.ts`), define the global observables for `tasks`, `healthAndHappiness`, and `checklistitems`.
    -   [ ] Configure each observable with the `syncedSupabase` utility, mapping them to the corresponding Supabase tables.
-   [x] **Task 4: Create DataSyncProvider** (AC: 3, 4)
    -   [x] Create a `DataSyncProvider.tsx` component.
    -   [x] This component will wrap the main `App` layout and will be responsible for calling the persistence configuration on startup.
-   [ ] **Task 5: Unit Testing** (AC: All)
    -   [ ] Write **Jest** unit tests for the persistence configuration to ensure plugins are correctly initialized.
    -   [ ] Write tests to verify that the observables are created with the correct sync configuration.

## Dev Notes

### Technical Guidance
* **Architecture Reference**: Follow the patterns outlined in `docs/architecture/brownfield-architecture.md`, specifically the "Data and Component Architecture" section.
* **Configuration**: The persistence setup should be centralized. This configuration will be called once when the application loads.
* **Observables**: The observables defined in this story will be the single source of truth for the entire application going forward. Ensure they are correctly mapped to the Supabase table names (`tasks`, `health_and_happiness`).

### Testing
* **Unit Tests**: Use **Jest**. Focus on testing the configuration logic. You will need to mock `AsyncStorage` and the `syncedSupabase` function to verify that they are called with the correct parameters.

